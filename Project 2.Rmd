---
title: "Project 2"
author: "OilGasDataAnalyst"
date: "October 20, 2015"
output: html_document
---

###Title:
NOAA Storm Database Severe Weather Analysis

###Synopsis:
Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.

###Data Processing
There should be a section titled Data Processing which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

Start with loading the librarys
```{r}
library(plyr)
```

Now we need to read in the data.
```{r, cache=TRUE}
StormData <- read.csv("repdata-data-StormData.csv.bz2")
head(StormData)
```

And create the 48 offical weather events as described in the student forums.
```{r}
weather48 <- c("Astronomical Low Tide", "Avalanche", "Blizzard", "Coastal Flood", "Cold/Wind Chill", "Debris Flow" , "Dense Fog", "Dense Smoke", "Drought", "Dust Devil", "Dust Storm", "Excessive Heat", "Extreme Cold/Wind Chill", "Flash Flood", "Flood", "Frost/Freeze", "Funnel Cloud", "Freezing Fog", "Hail", "Heat", "Heavy Rain", "Heavy Snow", "High Surf", "High Wind","Hurricane (Typhoon)", "Ice Storm", "Lake-Effect Snow", "Lakeshore Flood", "Lightning", "Marine Hail", "Marine High Wind", "Marine Strong Wind", "Marine Thunderstorm Wind", "Rip Current", "Seiche", "Sleet", "Storm Surge/Tide", "Strong Wind", "Thunderstorm Wind", "Tornado", "Tropical Depression", "Tropical Storm", "Tsunami", "V olcanic Ash", "Waterspout", "Wildfire", "Winter Storm", "Winter Weather")
```

After analyizing the data structure and reading the information from http://www.ncdc.noaa.gov/stormevents/details.jsp as found on the course forums, one can say we should only investigate incidents after 1996. Otherwise tornados will have an unusally high amount of injuries & damage. This still gives us 20 years of data to work with, time permitting we can look back at the rest of the pre-1996 data and see if its relatively inline with the post 1996 data.

So we need to extract the data after 1996. So first convert the dates and check that everything has converted properly.
```{r,cache=TRUE}
StormData$BGN_DATE <- as.Date(StormData$BGN_DATE, format = "%m/%d/%Y %H:%M:%S")
class(StormData$BGN_DATE)
sum(is.na(StormData$BGN_DATE))
```

Now we want to subset the data to a working range of data that we want to deal with.
```{r,cache=TRUE}
WorkingData <- subset(StormData, BGN_DATE >= "1996-01-01")
```

First we want to investigate how harmful to population health, i.e fatalities & injuries.
```{r, cache=TRUE}
HumanFatal <- aggregate(FATALITIES ~ EVTYPE,WorkingData,sum)
HumanInjury <- aggregate(INJURIES ~ EVTYPE,WorkingData,sum)
HumanImpact <- merge(HumanInjury, HumanFatal, by = "EVTYPE")
```

We now have a subset of data of the event types & number of injuries & fatalities that each of the event types have caused. Taking a look at the data `view(HumanImpact)` within RStudio we can see that a lot of the values have 0 for either fatalities or injuries. So lets go ahead and subset the data set down some more.
```{r}
HumanImpact <- subset(HumanImpact, (INJURIES > 0 & FATALITIES > 0))
```

We now want to get a combined total of injuries & fatalities for sorting on
```{r}
HumanImpact$Combined <- HumanImpact$INJURIES + HumanImpact$FATALITIES
HumanImpact <- HumanImpact[order(-HumanImpact$Combined),]
```

Taking a look at the data we can see clearly that Tornados have quite the impact!
```{r}
head(HumanImpact)
```

Lets plot out the data in a stacked bar chart, which is surprisingly hard! First we grab the top ten events and factor the event names.
```{r}
plotdata <- HumanImpact[1:10, 1:4]
plotdata$EVTYPE <- factor(plotdata$EVTYPE)
```

We then need to manipulate the data so that we can graph out as a bar chart, this needs to be a matrix, so first create a new data frame.
```{r}
Injury = c(plotdata$INJURIES)
Death = c(plotdata$FATALITIES)
df = data.frame(Injury, Death)
```

Then transpose the dataframe with `t()` and apply the event names across so that the x-axis is properly labeled. The `dtf` dataframe will be used to plot out the data in the results section.
```{r}
dft <- t(df)
colnames(dft) <- plotdata$EVTYPE
```

Now we move onto the second question, regarding economic consequences. First we need to take a look at the data:
```{r}
head(WorkingData)
```

From this we can identify four columns of data that we need to utilize, `PROPDMG`, `PROPDMGEXP`,`CROPDMG` & `CROPDMGEXP` in addtion to `EVTYPE`. So lets subset out this data into our new working variable, lets call it `EconData`
```{r}
EconData = data.frame(factor(WorkingData$EVTYPE),WorkingData$PROPDMG,WorkingData$PROPDMGEXP,WorkingData$CROPDMG,WorkingData$CROPDMGEXP)
colnames(EconData) <- c("EVTYPE","PROPDMG","PROPDMGEXP","CROPDMG","CROPDMGEXP")
head(EconData)
```

We can see lots of zero values, so lets filter these out.
```{r}
EconData <- subset(EconData, (PROPDMG > 0 & CROPDMG > 0))
```

Now according to the Storm Data Export document the EXP columns will be a multiplyer (if any) to apply to the damage amount, so lets multiply these across using the amazing `mapvalues` function within plyr. Also convert them to numeric.
```{r}
EconData$PROPDMGEXP <- as.character(EconData$PROPDMGEXP)
EconData$CROPDMGEXP <- as.character(EconData$CROPDMGEXP)

EconData$PROPDMGEXP <- mapvalues(EconData$PROPDMGEXP,c("K","M","B"),c(1000,1000000,1000000000))
EconData$CROPDMGEXP <- mapvalues(EconData$CROPDMGEXP,c("K","M","B"),c(1000,1000000,1000000000))

EconData$PROPDMGEXP <- sapply(EconData$PROPDMGEXP,as.numeric)
EconData$CROPDMGEXP <- sapply(EconData$CROPDMGEXP,as.numeric)
```

Now get NOMINAL values, this is important to remember.
```{r}
EconData$PROPDMG <- EconData$PROPDMG * EconData$PROPDMGEXP
EconData$CROPDMG <- EconData$CROPDMG * EconData$CROPDMGEXP
head(EconData)
```

Now do the same process as Q1 to get the data in an easy to read stacked bar chart.
```{r}

```


###Results

Your data analysis must address the following questions:




1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

Plotting out the data of the event types we can see tornados are the biggest threat in respect to population health.
```{r}
par(mar=c(7,5,1,1))
barplot(as.matrix(dft),cex.names = .6,col=c("black","red"),las = 2,ylab = "Count of Injuries/Fatalities", legend = c("Injuries","Fatalities"),mgp=c(3,.5,0))
```

2. Across the United States, which types of events have the greatest economic consequences?

Consider writing your report as if it were to be read by a government or municipal manager who might be responsible for preparing for severe weather events and will need to prioritize resources for different types of events. However, there is no need to make any specific recommendations in your report.

There should be a section titled Results in which your results are presented.

You may have other sections in your analysis, but Data Processing and Results are required.

The analysis document must have at least one figure containing a plot.

Your analyis must have no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.

You must show all your code for the work in your analysis document. This may make the document a bit verbose, but that is okay. In general, you should ensure that echo = TRUE for every code chunk (this is the default setting in knitr).
